---
layout: post
title:  "C++ - 소켓프로그래밍"
author: fennec-fox
tags: C++
category:  c++
---



# 소켓프로그래밍



### 소켓

- 전구나 형광등을 고정하는 도구 이자 전기를 공급하기 위한 투입구 역할을 수행한다.
- 프로그래밍 관전에서도 소켓의 의미는 프로그램이 네트워크에서 데이터를 송수신할 수 있도록 "**네트워크 환경에 연결할 수 있게 만들어진 연결부**"가 바로 네트워크 소켓이다.
- 보통 OSI 7 Layer의 네번째 계층인 TCP 상에서 동작한 소켓을 주로 사용하는데, 이를 TCP소켓 혹은 TCP/IP소켓이라고 한다.



### TCP/IP 소켓 프로그래밍 

- 다음의 사이트를 참고하자[https://wiserloner.tistory.com/703?category=831127]

<img src="https://img1.daumcdn.net/thumb/R800x0/?scode=mtistory2&fname=https%3A%2F%2Ft1.daumcdn.net%2Fcfile%2Ftistory%2F995C23465C7DD7E30B"/>



1. 소켓 생성

   ```c++
   
   socket(네트워크 주소 체계, 소켓 타입, 프로토콜)
   // 소켓 생성을 실패하는 경우 -1을 반환한다.
       
   네트워크 주소 체계 : IPv4(AF_INET), IPv6(AF_INET6)
       // 참고
         AF_INET : 인터넷 영역에서 사용할 소켓이라는 뜻
         AF_UNIX : 컴퓨터 내에서 프로세스간의 통신에 사용될 소켓이라는 뜻
   소켓 타입 : TCP(SOCK_STREAM), UDP(SOCK_DGRAM)
   프로토콜  : TCP(IPPROPTO_TCP), UDP(IPPROTO_UDP)    
       
       
   ** 소켓이 생성되면 0보다 큰 값이 반환된다. 이는 소켓 지정 번호라고 불리며
      소켓 관련 함수들이 이 소켓 지정 번호를 인자값으로 받아서 기능을 수행한다. 
       
   ```

   

2. 서버의 소켓에 IP와 포트번호를 할당하여 네트워크 인터페이스와 묶일 수 있도록 한다. 

   ```c++
   
   bind(소켓변수, 서버주소 구조체, 서버주소 구조체의 크기)
       
   소켓변수 : 생성된 소켓
   서버주소 구조체 : 주로 IPv4소켓주소구조체를 사용한다(소켓주소체계[sin_family], 포트[sin_port], IPv4[sin_addr])    
   
   ** 소켓 주소 구조체를 이용할 때는 IPv4소켓 주소 구조체를 일반 소켓 구조체(SOCKADDR)로 변환하여 사용해야한다.
   ** 소켓을 인터넷 주소에 묶어주기 위해서 사용한다. 
   ** 서버는 인터넷 너머에서 기다리기 위해, 자신이 어떠한 요청을 기다리는지를 명시해야 한다.    
       
   ```



3. 서버는 클라이언트로부터 연결 요청을 기다린다.

   ```c++
   
   listen(소켓변수, 백 로그 큐의 크기)
   
   백 로그 : 동시에 연결을 시도하는 최대 클라이언트의 수   
       
   ** 서버 소켓이 외부로부터 요청을 받았을 때 그것이 바로바로 처리되면 부하가 심해지므로
      중간에 처리할 요청을 저장하고, 차례로 실행시킬 완충역할을 하는 큐를 만들어 놓는 것이다.
       
   ```

   

4. 클라이언트에서 서버에 연결을 요청한다.

   ```c++
   
   connect(소켓변수, 서버주소 구조체, 서버주소 구조체의 크기)
       
   ** 소켓 주소 구조체를 이용할 때는 IPv4소켓 주소 구조체를 일반 소켓 구조체(SOCKADDR)로 변환하여 사용해야한다.
   ** 인터넷 주소와 포트번호를 이용하여 원격 소켓에 연결한다.    
       
   ```

   

5. 서버에서 연결을 수락한다.

   ```c++
   
   accpet(소켓변수, 클라이언트 주소 구조체변수, 클라이언트 주소 구조체 크기)
   // 함수 내부에서 클라이언트 주소를 설정한 뒤에 통신에 사용할 클라이언트의 소켓을 반환한다.
   // 오류 발생의 경우 -1을 반환한다    
       
   ** 소켓 주소 구조체를 이용할 때는 IPv4소켓 주소 구조체를 일반 소켓 구조체(SOCKADDR)로 변환하여 사용해야한다.  
   
   ```
   
   

6. 클라이언트에서( or 서버에서) 데이터를 보낸다.

   ```c++
   
   send(소켓변수, 문자열버퍼, 문자열 버퍼크기, 플래그)
   // 오류 발생의 경우 -1을 반환한다    
       
   문자열 버퍼크기 플래그 : 특별한 경우가 아니면 0을 설정한다   
   
   ```

   

7. 서버에서( or 클라이언트에서) 데이터를 받는다.

   ```c++
   
   recv(소켓변수, 문자열버퍼, 문자열 버퍼크기, 플래그)
   // 오류 발생의 경우 -1을 반환한다
       
   문자열 버퍼크기 플래그 : 특별한 경우가 아니면 0을 설정한다      
   
   ```

   

8. 소켓을 닫는다.

   ```c++
   
   closesocket(소켓변수)
   
   ```

   





> ### 서버와 클라이언트 통신 흐름 정리
>
> 

```html

1. 서버 소켓 생성 및, 자기 자신에 대한 포트 번호를 열어두고, bind를 통해 요청 대기

2. 클라이언트 소켓 생성 및, connect를 이용하여, 서버 소켓의 IP주소와 포트번호로 요청을 보냄.(우리 대화좀 합시다! 하고 전화를 보낸 것과 같습니다.)

3. 서버 소켓은 해당 요청에 대해서, listen으로, 실행 큐에 보내버리고, accept를 통하여, 우리에게 전화를 한 곳의 IP주소와 포트번호가 무엇인지를 알아낸 후, 그곳으로 연결이 가능한 연결 소켓을 생성해냄.

(사실상 서버는, 여러 사람이 전화할 것을 가정하고 있고, 전화 요청을 받는 전화기를 한대 놔둔 후, 그곳에 요청이 들어오면, 그 요청을 큐에 메모해둔 뒤에, 그에 맞는 정보를 지닌 전용 전화기를 한대 준비해두는 개념이라 할수 있겠네요.)

4. 서버와 클라이언트는, 생성된 그 소켓을 통해 통신이 가능합니다.(서버 / 클라이언트 모델의 경우에는, 서버가 클라이언트의 요청이 담긴, 메시지를 read하고, 이후, 그에 맞는 응답을 write 한후 끝이겠죠. 이를 반복합니다.)

5. 마지막으로, 용무가 끝난 소켓은, close로 소멸하여 연결 종료됩니다.

```





> ### 소켓프로그래밍과 웹프로그래밍
>
>   
>
> 참고 : https://www.clien.net/service/board/kin/11263573
>
> 



> ### 아파치(Apache), 톰캣(Tomcat), 엔진엑스(Nginx) 차이
>
>    
>
> 참고 : https://velog.io/@ksso730/Nginx-Apache-%EB%B9%84%EA%B5%90
>
> 참고 :  https://losskatsu.github.io/it-infra/webserver/
>
> 참고 :  https://jeong-pro.tistory.com/84
>
> 

